<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title id="t_title">LoRa Crack Monitoring</title>
<style>
:root { color-scheme: light dark; --bg:#111; --fg:#eee; --card:#1a1a1a; --border:#333; --muted:#9aa; --field:#222; --btn:#222; }
html[data-theme="light"] { --bg:#fff; --fg:#111; --card:#f7f7f8; --border:#ddd; --muted:#556; --field:#fff; --btn:#f3f4f6; }
* { box-sizing:border-box }
html,body { height:100% }
body { font-family:system-ui,Arial,sans-serif; margin:16px; background:var(--bg); color:var(--fg); display:flex; flex-direction:column; min-height:10svh; max-height:95svh; }
.main { flex:1; max-height:85vh; overflow:hidden; }
h1 { font-size:20px;margin:0 0 12px;display:flex;align-items:center;justify-content:space-between;gap:8px }
h3 { margin:0 0 8px }
.grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px }
.card { background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px }
.k { color:var(--muted) }
.row { display:flex;gap:8px;flex-wrap:wrap;align-items:center }
input,button { padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--field);color:var(--fg) }
button:hover { background:var(--btn) }
.field { display:flex;gap:6px;align-items:center;margin-top:8px }
.field input { flex:1 }
.field label { min-width:120px }
small { color:var(--muted) }
#themeBtn,#langBtn { font-size:14px;line-height:1;padding:6px 10px }
.footer { margin-top:16px;padding-top:12px;border-top:1px solid var(--border);font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center }
.footer a { color:inherit;text-decoration:none }
.footer a:hover { text-decoration:underline }
.hr { height:1px;background:var(--border);margin:10px 0 }
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:var(--btn)}
.badge.ok{outline:1px solid #2c7; }
.badge.err{outline:1px solid #e55; }
</style>
</head>
<body>
<h1>
  <span><img src="/logo.svg" alt="MKP" style="height:28px;vertical-align:middle;margin-right:8px"><span id="i_title">LoRa Crack Monitoring</span></span>
  <div class="row">
    <button id="langBtn" title="Language">EN</button>
    <button id="themeBtn" title="Theme">🌙</button>
  </div>
</h1>

<main class="main">
<div class="grid">
  <!-- Sensors -->
  <div class="card">
    <h3 id="i_sensors">Sensors</h3>
    <div><span class="k" id="i_time_k">Time</span>: <b id="t">--:--:--</b></div>
    <div><span class="k" id="i_ds_k">DS18B20</span>: <b id="ds">--.-</b> °C</div>
    <div><span class="k" id="i_adc_k">Crack ADC</span>: <b id="adc">-</b></div>
    <div><span class="k" id="i_crack_status_k">Crack sensor</span>: <span id="cr_status" class="badge">—</span></div>
    <div><span class="k" id="i_crack_k">Crack</span>: <b id="crk">-</b> <span id="i_mm">mm</span></div>
    <div><span class="k" id="i_bat_k">Battery</span>: <b id="bat">-</b> <span id="i_mv">mV</span></div>
  </div>

  <!-- Controller -->
  <div class="card">
    <h3 id="i_controller">Controller</h3>
    <div><span class="k" id="i_mode_k">Mode</span>: <b id="mode">-</b></div>
    <div><span class="k" id="i_ip_k">IP</span>: <b id="ip">-</b></div>
    <div><span class="k" id="i_uptime_k">Uptime</span>: <b id="up">-</b> <span id="i_seconds">s</span></div>
    <div><span class="k" id="i_heap_k">Heap</span>: <b id="heap">-</b> B</div>
    <div class="hr"></div>
    <div class="row">
      <button id="btnSend">Manual LoRa send</button>
      <button id="btnReset">Reboot</button>
      <small id="msg"></small>
    </div>
  </div>

  <!-- LoRa -->
  <div class="card">
    <h3 id="i_lora">LoRa</h3>
    <div class="row">
      <button id="btnReadChip">Read DevEUI from chip</button>
      <button id="btnSaveChip">DevEUI</button>
    </div>

    <div class="field">
      <label for="devEuiField" id="i_deveui_k">DevEUI</label>
      <input id="devEuiField" placeholder="DevEUI MSB e.g. 0011223344556677">
      <button id="btnSaveDev">DevEUI</button>
    </div>

    <div class="field">
      <label for="appEuiField" id="i_appeui_k">AppEUI</label>
      <input id="appEuiField" placeholder="AppEUI MSB">
      <button id="btnSaveAppEUI">Save</button>
    </div>

    <div class="field">
      <label for="appKeyField" id="i_appkey_k">AppKey</label>
      <input id="appKeyField" placeholder="AppKey MSB">
      <button id="btnSaveAppKey">Save</button>
    </div>

    <div class="field">
      <label for="minutesField" id="i_interval_k">Interval</label>
      <input id="minutesField" type="number" min="1" placeholder="Interval, min">
      <button id="btnSaveMinutes">Save</button>
    </div>

    <small id="devEuiMsg"></small>
  </div>

  <!-- Crack calibration -->
  <div class="card">
    <h3 id="i_crcal">Crack calibration</h3>
    <div class="field">
      <label for="r0Field" id="i_r0_k">ADC r0</label>
      <input id="r0Field" type="number" step="1" placeholder="e.g. 25484">
    </div>
    <div class="field">
      <label for="mm0Field" id="i_mm0_k">mm0</label>
      <input id="mm0Field" type="number" step="0.01" min="0" placeholder="e.g. 0">
    </div>
    <div class="field">
      <label for="r1Field" id="i_r1_k">ADC r1</label>
      <input id="r1Field" type="number" step="1" placeholder="e.g. 5">
    </div>
    <div class="field">
      <label for="mm1Field" id="i_mm1_k">mm1</label>
      <input id="mm1Field" type="number" step="0.01" min="0" placeholder="e.g. 10">
    </div>
    <div class="row">
      <button id="btnSaveCal">Save</button>
      <small id="calMsg"></small>
    </div>
  </div>
</div>
</main>

<footer class="footer">
  <span>© <span id="yr"></span> MKP GmbH</span>
  <span id="i_footer_by">developed by</span>
  <a href="mailto:roman.sliusar@marxkrontal.com">SLR</a>
  <a href="mailto:evgenij.koloda@marxkrontal.com">KOE</a>
  <a href="mailto:Bernd.Schinkoethe@marxkrontal.com">SCE</a>
</footer>

<script>
const THEME_KEY='theme', LANG_KEY='lang';
let I18N={}, CURR_LANG='en';
const LANGS=['en','de','uk'];

function setTheme(t){
  document.documentElement.dataset.theme=t;
  document.getElementById('themeBtn').textContent=(t==='dark'?'☀️':'🌙');
  localStorage.setItem(THEME_KEY,t);
}
function fmtTime(){const d=new Date(),p=n=>String(n).padStart(2,'0');return `${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;}
function byId(i){return document.getElementById(i);}
async function q(url,opts){const r=await fetch(url,opts);if(!r.ok)throw new Error(await r.text());const ct=r.headers.get('content-type')||'';return ct.includes('application/json')?r.json():r.text();}

function applyI18n(){
  const t=I18N[CURR_LANG]||I18N['en']||{};
  byId('i_title').textContent=t.title||'LoRa Crack Monitoring';
  byId('t_title').textContent=t.title||'LoRa Crack Monitoring';
  byId('i_sensors').textContent=t.sensors||'Sensors';
  byId('i_time_k').textContent=t.time||'Time';
  byId('i_ds_k').textContent=t.ds18b20||'DS18B20';
  byId('i_adc_k').textContent=t.crack_adc||'Crack ADC';
  byId('i_crack_status_k').textContent=t.crack_status||'Crack sensor';
  byId('i_crack_k').textContent=t.crack||'Crack';
  byId('i_bat_k').textContent=t.battery||'Battery';
  byId('i_mm').textContent=t.mm||'mm';
  byId('i_mv').textContent=t.mv||'mV';
  byId('i_controller').textContent=t.controller||'Controller';
  byId('i_mode_k').textContent=t.mode||'Mode';
  byId('i_ip_k').textContent=t.ip||'IP';
  byId('i_uptime_k').textContent=t.uptime||'Uptime';
  byId('i_seconds').textContent=t.seconds||'s';
  byId('i_heap_k').textContent=t.heap||'Heap';
  byId('btnSend').textContent=t.send||'Send';
  byId('btnReset').textContent=t.reboot||'Reboot';
  byId('i_lora').textContent=t.lora||'LoRa';
  byId('btnReadChip').textContent=t.read_chip||'Read chip';
  byId('btnSaveChip').textContent=t.save_chip||'Save chip';
  byId('btnSaveDev').textContent=t.save_deveui||'Save DevEUI';
  byId('btnSaveAppEUI').textContent=t.save||'Save';
  byId('btnSaveAppKey').textContent=t.save||'Save';
  byId('btnSaveMinutes').textContent=t.save||'Save';
  byId('devEuiField').placeholder=t.ph_deveui||'DevEUI';
  byId('appEuiField').placeholder=t.ph_appeui||'AppEUI';
  byId('appKeyField').placeholder=t.ph_appkey||'AppKey';
  byId('minutesField').placeholder=t.ph_minutes||'Interval';
  byId('i_footer_by').textContent=t.footer_by||'developed by';
  byId('i_deveui_k').textContent=t.deveui||'DevEUI';
  byId('i_appeui_k').textContent=t.appeui||'AppEUI';
  byId('i_appkey_k').textContent=t.appkey||'AppKey';
  byId('i_interval_k').textContent=t.interval||'Interval';
  // calibration labels
  byId('i_crcal').textContent=t.crack_cal||'Crack calibration';
  byId('i_r0_k').textContent=t.r0||'ADC r0';
  byId('i_mm0_k').textContent=t.mm0||'mm0';
  byId('i_r1_k').textContent=t.r1||'ADC r1';
  byId('i_mm1_k').textContent=t.mm1||'mm1';
  byId('btnSaveCal').textContent = t.save || 'Save';
  byId('langBtn').textContent=CURR_LANG.toUpperCase();
}

async function initI18n(){
  try{I18N=await q('/i18n.json');}catch(e){I18N={};}
  const saved=localStorage.getItem(LANG_KEY);
  CURR_LANG=saved&&LANGS.includes(saved)?saved:'en';
  applyI18n();
}

document.addEventListener('DOMContentLoaded',()=>{
  const savedTheme=localStorage.getItem(THEME_KEY);
  const initTheme=savedTheme||(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
  setTheme(initTheme);
  byId('themeBtn').onclick=()=>setTheme(document.documentElement.dataset.theme==='dark'?'light':'dark');
  const y=byId('yr');if(y)y.textContent=new Date().getFullYear();
  byId('langBtn').onclick=()=>{const idx=LANGS.indexOf(CURR_LANG);CURR_LANG = LANGS[(idx + 1) % LANGS.length];
  localStorage.setItem(LANG_KEY,CURR_LANG);applyI18n();};
  initI18n();
  setInterval(load,2000);load();
});

function setCrackStatus(present){
  const el=byId('cr_status');
  if(present){
    el.textContent='OK';
    el.classList.remove('err'); el.classList.add('ok');
  }else{
    el.textContent='N/C';
    el.classList.remove('ok'); el.classList.add('err');
  }
}

async function load(){
  try{
    const s=await q('/api/state');
    byId('t').textContent=fmtTime();
    byId('ds').textContent=(s.DS18B20_Temp??'--.-');
    const present=!!s.crack_present;

    // ADC & Crack
    byId('adc').textContent = present ? (s.adc_raw??'-') : 'N/C';
    setCrackStatus(present);

    if(present){
      if(s.crack_mm!=null){
        byId('crk').textContent=(+s.crack_mm).toFixed(3);
      }else if(s.crack_x100!=null){
        byId('crk').textContent=(s.crack_x100/100).toFixed(3);
      }else{
        byId('crk').textContent='-';
      }
    }else{
      byId('crk').textContent='N/C';
    }

    byId('bat').textContent=(s.batt_mV??'-');
    byId('mode').textContent=s.mode||'-';
    byId('ip').textContent=s.ip||'-';
    byId('up').textContent=s.uptime_s??'-';
    byId('heap').textContent=s.heap_free??'-';

    if(s.cfg){
      if(!byId('devEuiField').value)byId('devEuiField').value=s.cfg.devEui||'';
      if(!byId('appEuiField').value)byId('appEuiField').value=s.cfg.appEui||'';
      if(!byId('appKeyField').value)byId('appKeyField').value=s.cfg.appKey||'';
      if(!byId('minutesField').value)byId('minutesField').value=s.cfg.minutes??15;

      if(s.cfg.crack_cal){
        const cc=s.cfg.crack_cal;
        if(cc.r0!=null && !byId('r0Field').value)  byId('r0Field').value=cc.r0;
        if(cc.mm0!=null && !byId('mm0Field').value)byId('mm0Field').value=(+cc.mm0).toFixed(2);
        if(cc.r1!=null && !byId('r1Field').value)  byId('r1Field').value=cc.r1;
        if(cc.mm1!=null && !byId('mm1Field').value)byId('mm1Field').value=(+cc.mm1).toFixed(2);
      }
    }
  }catch(e){
    const t=I18N[CURR_LANG]||I18N['en']||{};
    byId('msg').textContent=t.msg_state_error||'state error';
  }
}

async function saveLoRaField(k,v){
  const t=I18N[CURR_LANG]||I18N['en']||{};
  try{
    await fetch('/api/config/lora',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});
    byId('devEuiMsg').textContent=t.msg_saved_reboot||'Saved; rebooting…';
  }catch(e){byId('devEuiMsg').textContent=t.msg_save_error||'Save error';}
}

async function readDevEUI(){
  try{
    const j=await q('/api/deveui');
    byId('devEuiField').value=j.chip_devEui_msb||'';
    byId('devEuiMsg').textContent=`chip MSB=${j.chip_devEui_msb}  LSB=${j.chip_devEui_lsb}  stored=${j.stored_devEui_msb}`;
  }catch(e){
    const t=I18N[CURR_LANG]||I18N['en']||{};
    byId('devEuiMsg').textContent=t.msg_save_error||'Save error';
  }
}
async function saveChipDevEUI(){
  const t=I18N[CURR_LANG]||I18N['en']||{};
  try{
    await fetch('/api/deveui',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({use:'chip'})});
    byId('devEuiMsg').textContent=t.msg_saved_reboot||'Saved; rebooting…';
  }catch(e){byId('devEuiMsg').textContent=t.msg_save_error||'Save error';}
}
async function saveDevEUI(){
  const h=byId('devEuiField').value.trim();
  const t=I18N[CURR_LANG]||I18N['en']||{};
  try{
    await fetch('/api/deveui',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({devEui:h})});
    byId('devEuiMsg').textContent=t.msg_saved_reboot||'Saved; rebooting…';
  }catch(e){byId('devEuiMsg').textContent=t.msg_save_error||'Save error';}
}

async function saveCrackCal(){
  const t=I18N[CURR_LANG]||I18N['en']||{};
  const r0=parseInt(byId('r0Field').value);
  const r1=parseInt(byId('r1Field').value);
  const mm0=parseFloat(byId('mm0Field').value);
  const mm1=parseFloat(byId('mm1Field').value);
  const msg=byId('calMsg');

  if(!Number.isFinite(r0)||!Number.isFinite(r1)||!Number.isFinite(mm0)||!Number.isFinite(mm1)){
    msg.textContent=t.msg_save_error||'Save error'; return;
  }
  try{
    await fetch('/api/config/lora',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({crack_cal:{r0,mm0,r1,mm1}})
    });
    msg.textContent=t.msg_saved_reboot||'Saved; rebooting…';
  }catch(e){
    msg.textContent=t.msg_save_error||'Save error';
  }
}

byId('btnReadChip').onclick=readDevEUI;
byId('btnSaveChip').onclick=saveChipDevEUI;
byId('btnSaveDev').onclick=saveDevEUI;
byId('btnSaveAppEUI').onclick=()=>saveLoRaField('appEui',byId('appEuiField').value);
byId('btnSaveAppKey').onclick=()=>saveLoRaField('appKey',byId('appKeyField').value);
byId('btnSaveMinutes').onclick=()=>saveLoRaField('minutes',parseInt(byId('minutesField').value||'15'));
byId('btnSaveCal').onclick=saveCrackCal;

byId('btnSend').onclick=async()=>{
  const t=I18N[CURR_LANG]||I18N['en']||{};
  try{const r=await fetch('/api/send',{method:'POST'});byId('msg').textContent=(r.ok?(t.msg_send_ok||'LoRa queued'):(t.msg_send_err||'Send error')); }
  catch(e){byId('msg').textContent=t.msg_send_err||'Send error';}
};
byId('btnReset').onclick=async()=>{
  const t=I18N[CURR_LANG]||I18N['en']||{};
  try{const r=await fetch('/api/reset',{method:'POST'});byId('msg').textContent=(r.ok?(t.msg_restarting||'restarting…'):(t.msg_reset_forbidden||'Reset forbidden')); }
  catch(e){byId('msg').textContent=t.msg_save_error||'Save error';}
};
</script>
</body>
</html>
