<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title id="t_title">LoRa Crack Monitoring</title>
<style>
/* === Theme tokens === */
:root{
  --bg:#111; --fg:#eee; --card:#1a1a1a; --border:#333; --muted:#9aa; --field:#222; --btn:#222;
  --ff:system-ui,Arial,sans-serif; --fs:14px; --lh:1.35;
  --in-fs:14px; --in-lh:1; --in-pad-y:8px; --in-pad-x:16px; --in-radius:12px;
}
html[data-theme="light"]{
  color-scheme: light;
  /* палітра від найсвітлішого до темнішого */
  --g0:#f6f7f8; --g1:#eef0f1; --g2:#e3e5e7; --g3:#d8dadc; --g4:#cdd0d3; --g5:#c2c5c8;

  --bg:var(--g0);
  --fg:#111; --border:#ddd; --muted:#556; --field:#fff; --btn:#f3f4f6;
  --card:var(--g3);
}

html[data-theme="dark"]{ color-scheme: dark; }

/* Base */
*{box-sizing:border-box}
html,body{height:100%}
html,body{font-family:var(--ff);font-size:var(--fs);line-height:var(--lh)}
body{margin:16px;background:var(--bg);color:var(--fg);display:flex;flex-direction:column;min-height:10svh;max-height:95svh}
.main{flex:1;max-height:85vh;overflow:hidden}
h1{font-size:20px;margin:0 0 12px;display:flex;align-items:center;justify-content:space-between;gap:8px}
h3{margin:0 0 8px}
h1,h3{font-family:var(--ff);line-height:1.2}
h1{font-weight:700} h3{font-weight:600}
.k,small,label{font:inherit}

/* Grid */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column}
.hr{height:1px;background:var(--border);margin:10px 0}

/* Controls */
button,input,select,textarea{font:inherit;line-height:inherit;color:inherit}
input,select,textarea{
  font-size:var(--in-fs);line-height:var(--in-lh);
  padding:var(--in-pad-y) var(--in-pad-x);
  border:1px solid var(--border);border-radius:var(--in-radius);
  background:var(--field);color:var(--fg);
}
input:focus,select:focus,textarea:focus{outline:none;box-shadow:0 0 0 2px inset var(--border)}
select{-webkit-appearance:none;-moz-appearance:none;appearance:none}
.grid > .card{ background:var(--cardTone, var(--card)); }
.grid > .card:nth-of-type(5n+1){ --cardTone:var(--g5) }
.grid > .card:nth-of-type(5n+2){ --cardTone:var(--g4) }
.grid > .card:nth-of-type(5n+3){ --cardTone:var(--g3) }
.grid > .card:nth-of-type(5n+4){ --cardTone:var(--g2) }
.grid > .card:nth-of-type(5n+5){ --cardTone:var(--g1) }

/* Field layout */
.field{display:flex;gap:4px;align-items:center;margin-top:8px}
.field input,.field select{flex:1;min-width:0}
.field label{min-width:120px;font-size:16px}

/* Buttons */
.btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--field);color:var(--fg);font-weight:600;margin-top:8px}
.btn:hover{background:var(--btn)}
.btn-block{display:block;width:100%}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.actions{margin-top:auto}

/* LoRa: 2 кнопки однакові */
.card:has(#i_lora) .row{display:flex;gap:12px}
.card:has(#i_lora) .row .btn{flex:1 1 0;min-width:0;height:48px;display:flex;align-items:center;justify-content:center}

/* Badges */
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:var(--btn)}
.badge.ok{outline:1px solid #2c7}
.badge.err{outline:1px solid #e55}

small{color:var(--muted)}
#themeBtn,#langBtn{font-size:14px;line-height:1;padding:6px 10px}

/* Footer */
.footer{margin-top:16px;padding-top:12px;border-top:1px solid var(--border);font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
.footer a{color:inherit;text-decoration:none}
.footer a:hover{text-decoration:underline}

/* LoRa layout: label | input */
.card:has(#i_lora) .field{display:grid;grid-template-columns:120px minmax(0,1fr);column-gap:6px;row-gap:8px}
.status{display:block;min-height:1.2em;margin-bottom:6px;color:var(--muted);word-break:break-word;white-space:pre-line}

/* Tablet */
@media (max-width:900px){
  body{margin:10px}
  .main{max-height:none;overflow:auto}
  .grid{grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
  h1{flex-wrap:wrap;gap:8px}
  .row{flex-wrap:wrap;gap:6px}
}

/* Phones */
@media (max-width:640px){
  body{margin:8px}
  h1{flex-direction:column;align-items:flex-start}
  .grid{grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
  .field{flex-direction:column;align-items:stretch}
  .field label{min-width:unset}
  input,.btn,select{width:100%;max-width:100%}
  .row{width:100%}
  .card:has(#i_lora) .field{grid-template-columns:1fr}
}

/* Very narrow phones */
@media (max-width:360px){
  .grid{grid-template-columns:1fr}
  h1 img{height:22px}
  #themeBtn,#langBtn{padding:6px 8px;font-size:13px}
}
</style>
</head>
<body>
<h1>
  <a href="https://www.marxkrontal.com/de/" target="_blank" style="display:flex;align-items:center;text-decoration:none;color:inherit;gap:8px">
    <img src="/logo.svg" alt="MKP" style="height:28px;vertical-align:middle">
    <span id="i_title">LoRa Crack Monitoring</span>
  </a>
  <div class="row">
    <button id="langBtn" class="btn" title="Language">EN</button>
    <button id="themeBtn" class="btn" title="Theme">🌙</button>
  </div>
</h1>

<main class="main">
<div class="grid">
  <!-- Sensors -->
  <div class="card">
    <h3 id="i_sensors">Sensors</h3>
    <div><span class="k" id="i_time_k">Time</span>: <b id="t">--:--:--</b></div>
    <div>
      <span class="k" id="i_ds_k">DS18B20</span>:
      <span id="ds">-</span><span id="ds_unit"> °C</span>
    </div>

    <div><span class="k" id="i_adc_k">Crack ADC</span>: <b id="adc">-</b></div>
    <div><span class="k" id="i_crack_status_k">Crack sensor</span>: <span id="cr_status" class="badge">—</span></div>
    <div><span class="k" id="i_crack_k">Crack</span>: <b id="crk">-</b> <span id="i_mm">mm</span></div>
    <div><span class="k" id="i_bat_k">Battery</span>: <b id="bat">-</b> <span id="i_mv">mV</span></div>
  </div>

  <!-- Controller -->
  <div class="card">
    <h3 id="i_controller">Controller</h3>
    <div><span class="k" id="i_mode_k">Mode</span>: <b id="mode">-</b></div>
    <div><span class="k" id="i_ip_k">IP</span>: <b id="ip">-</b></div>
    <div><span class="k" id="i_uptime_k">Uptime</span>: <b id="up">-</b> s</div>
    <div><span class="k" id="i_heap_k">Heap</span>: <b id="heap">-</b> B</div>
    <div><span class="k" id="i_rssi_k">RSSI</span>: <b id="rssi">—</b> dBm</div>
    <div><span class="k" id="i_snr_k">SNR</span>: <b id="snr">—</b> dB</div>
    <div><span class="k" id="i_dlage_k">DL age</span>: <b id="dlage">—</b> s</div>
    <div class="hr"></div>
    <div class="actions">
      <small id="msg" class="status" aria-live="polite"></small>
      <div class="row">
        <button id="btnSend" class="btn">Manual LoRa send</button>
        <button id="btnReset" class="btn">Reboot</button>
      </div>
    </div>
  </div>

  <!-- LoRa -->
  <div class="card">
    <h3 id="i_lora">LoRa</h3>
    <div class="row">
      <button id="btnReadChip" class="btn">Read DevEUI from chip</button>
      <button id="btnSaveChip" class="btn">Use chip DevEUI</button>
    </div>

    <div class="field">
      <label for="devEuiField" id="i_deveui_k">DevEUI</label>
      <input id="devEuiField" placeholder="DevEUI MSB e.g. 0011223344556677">
    </div>
    <div class="field">
      <label for="appEuiField" id="i_appeui_k">AppEUI</label>
      <input id="appEuiField" placeholder="AppEUI MSB">
    </div>
    <div class="field">
      <label for="appKeyField" id="i_appkey_k">AppKey</label>
      <input id="appKeyField" placeholder="AppKey MSB">
    </div>
    <div class="field">
      <label for="minutesField" id="i_interval_k">Interval</label>
      <input id="minutesField" type="number" min="1" placeholder="Interval, min">
    </div>
    <div class="field">
      <label for="drField" id="i_dr_k">DataRate (EU868)</label>
      <select id="drField">
        <option id="opt_dr_auto" value="auto">Auto</option>
        <option value="0">DR0 (SF12 / 125kHz)</option>
        <option value="1">DR1 (SF11 / 125kHz)</option>
        <option value="2">DR2 (SF10 / 125kHz)</option>
        <option value="3">DR3 (SF9  / 125kHz)</option>
        <option value="4">DR4 (SF8  / 125kHz)</option>
        <option value="5">DR5 (SF7  / 125kHz)</option>
      </select>
    </div>

    <!-- Time sync -->
    <div class="field">
      <label for="syncField" id="i_sync_k">Time sync</label>
      <select id="syncField">
        <option value="off">Off</option>
        <option value="1">1 h</option>
        <option value="2">2 h</option>
        <option value="3">3 h</option>
        <option value="6">6 h</option>
        <option value="12">12 h</option>
        <option value="24">24 h</option>
        <option value="48">2 d</option>
        <option value="72">3 d</option>
        <option value="168">1 w</option>
      </select>
    </div>

    <div class="actions">
      <button id="btnSaveLoRa" class="btn btn-block">Save all LoRa settings</button>
      <small id="devEuiMsg"></small>
    </div>
  </div>

  <!-- Crack calibration -->
  <div class="card">
    <h3 id="i_crcal">Crack calibration</h3>
    <div class="field">
      <label for="r0Field" id="i_r0_k">ADC r0</label>
      <input id="r0Field" type="number" step="1" placeholder="e.g. 25484">
    </div>
    <div class="field">
      <label for="mm0Field" id="i_mm0_k">mm0</label>
      <input id="mm0Field" type="number" step="0.01" min="0" placeholder="e.g. 0">
    </div>
    <div class="field">
      <label for="r1Field" id="i_r1_k">ADC r1</label>
      <input id="r1Field" type="number" step="1" placeholder="e.g. 5">
    </div>
    <div class="field">
      <label for="mm1Field" id="i_mm1_k">mm1</label>
      <input id="mm1Field" type="number" step="0.01" min="0" placeholder="e.g. 10">
    </div>

    <div class="actions">
      <button id="btnSaveCalAll" class="btn btn-block">Save crack calibration</button>
      <small id="calMsg"></small>
    </div>
  </div>
</div>
</main>

<footer class="footer">
  <a href="https://www.marxkrontal.com/de/" target="_blank">© <span id="yr"></span> MKP GmbH</a>
  <span id="i_footer_by">developed by</span>
  <a href="mailto:roman.sliusar@marxkrontal.com">SLR</a>
  <a href="mailto:evgenij.koloda@marxkrontal.com">KOE</a>
  <a href="mailto:Bernd.Schinkoethe@marxkrontal.com">SCE</a>
</footer>

<script>
const THEME_KEY='theme', LANG_KEY='lang';
let I18N={}, CURR_LANG='en';

function byId(i){return document.getElementById(i)}
function setTheme(t){
  document.documentElement.dataset.theme=t;
  byId('themeBtn').textContent=(t==='dark'?'☀️':'🌙');
  localStorage.setItem(THEME_KEY,t);
}
function fmtTime(){const d=new Date(),p=n=>String(n).padStart(2,'0');return `${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`}
async function q(url,opts){const r=await fetch(url,opts);if(!r.ok)throw new Error(await r.text());const ct=r.headers.get('content-type')||'';return ct.includes('application/json')?r.json():r.text()}

function applyI18n(){
  const t = I18N[CURR_LANG] || I18N['en'] || {};

  byId('i_title').textContent = t.title || 'LoRa Crack Monitoring';
  byId('t_title').textContent = t.title || 'LoRa Crack Monitoring';
  byId('i_sensors').textContent = t.sensors || 'Sensors';
  byId('i_time_k').textContent = t.time || 'Time';
  byId('i_ds_k').textContent = t.ds18b20 || 'DS18B20';
  byId('i_adc_k').textContent = t.crack_adc || 'Crack ADC';
  byId('i_crack_status_k').textContent = t.crack_status || 'Crack sensor';
  byId('i_crack_k').textContent = t.crack || 'Crack';
  byId('i_bat_k').textContent = t.battery || 'Battery';
  byId('i_mm').textContent = t.mm || 'mm';
  byId('i_mv').textContent = t.mv || 'mV';
  byId('i_controller').textContent = t.controller || 'Controller';
  byId('i_mode_k').textContent = t.mode || 'Mode';
  byId('i_ip_k').textContent = t.ip || 'IP';
  byId('i_uptime_k').textContent = t.uptime || 'Uptime';
  byId('i_heap_k').textContent = t.heap || 'Heap';
  byId('i_rssi_k').textContent = t.rssi || 'RSSI';
  byId('i_snr_k').textContent = t.snr || 'SNR';
  byId('i_dlage_k').textContent = t.dl_age || 'DL age';
  byId('i_footer_by').textContent = t.footer_by || 'developed by';
  byId('i_deveui_k').textContent = t.deveui || 'DevEUI';
  byId('i_appeui_k').textContent = t.appeui || 'AppEUI';
  byId('i_appkey_k').textContent = t.appkey || 'AppKey';
  byId('i_interval_k').textContent = t.interval || 'Interval';
  byId('i_crcal').textContent = t.crack_cal || 'Crack calibration';
  byId('i_r0_k').textContent = t.r0 || 'ADC r0';
  byId('i_mm0_k').textContent = t.mm0 || 'mm0';
  byId('i_r1_k').textContent = t.r1 || 'ADC r1';
  byId('i_mm1_k').textContent = t.mm1 || 'mm1';
  byId('i_dr_k').textContent = t.drate || 'DataRate (EU868)';
  byId('i_sync_k').textContent = t.time_sync || 'Time sync';

  const optAuto = byId('opt_dr_auto'); if (optAuto) optAuto.textContent = t.auto || 'Auto';

  byId('langBtn').textContent = CURR_LANG.toUpperCase();
}

document.addEventListener('DOMContentLoaded',()=>{
  const savedTheme=localStorage.getItem(THEME_KEY);
  const initTheme=savedTheme||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
  setTheme(initTheme);
  byId('themeBtn').onclick=()=>setTheme(document.documentElement.dataset.theme==='dark'?'light':'dark');
  const y=byId('yr');if(y)y.textContent=new Date().getFullYear();
  byId('langBtn').onclick=()=>{
    const LANGS=['en','de','uk'];
    const idx=LANGS.indexOf(CURR_LANG);CURR_LANG=LANGS[(idx+1)%LANGS.length];
    localStorage.setItem(LANG_KEY,CURR_LANG);applyI18n();
  };
  initI18n();
  setInterval(load,2000);load();
});

async function initI18n(){
  try{I18N=await q('/i18n.json')}catch(e){I18N={}}
  const saved=localStorage.getItem(LANG_KEY);
  CURR_LANG=saved&&['en','de','uk'].includes(saved)?saved:'en';
  applyI18n();
}

function setCrackStatus(present){
  const t = I18N[CURR_LANG] || I18N['en'] || {};
  const el = byId('cr_status');
  if(present){ el.textContent = t.ok || 'OK'; el.classList.remove('err'); el.classList.add('ok'); }
  else{ el.textContent = t.nc || 'N/C'; el.classList.remove('ok'); el.classList.add('err'); }
}

async function readDevEUI(){
  try{
    const j=await q('/api/deveui');
    byId('devEuiField').value=j.chip_devEui_msb||'';
    const t=I18N[CURR_LANG]||I18N['en']||{};
    byId('devEuiMsg').textContent =
      `${(t.chip_msb||'chip MSB')}=${j.chip_devEui_msb}  ` +
      `${(t.chip_lsb||'LSB')}=${j.chip_devEui_lsb}  ` +
      `${(t.stored_msb||'stored')}=${j.stored_devEui_msb}`;
  }catch(e){
    const t=I18N[CURR_LANG]||I18N['en']||{};
    byId('devEuiMsg').textContent=t.msg_save_error||'Save error';
  }
}

async function load(){
  try{
    const s=await q('/api/state');
    byId('t').textContent=fmtTime();

    // DS18B20
    const vRaw = s.DS18B20_Temp;
    const vNum = Number(vRaw);
    const dsHasValue =
      vRaw !== null && vRaw !== undefined &&
      Number.isFinite(vNum) && vNum > -100 && vNum < 125;

    if (dsHasValue) {
      byId('ds').textContent = vNum.toFixed(1);
      byId('ds').classList.remove('badge','err','ok');
      byId('ds_unit').textContent = ' °C';
    } else {
      const t = I18N[CURR_LANG] || I18N['en'] || {};
      byId('ds').textContent = t.nc || 'N/C';
      byId('ds').classList.add('badge','err');
      byId('ds_unit').textContent = '';
    }

    const present=!!s.crack_present;

    byId('adc').textContent=present?(s.adc_raw??'-'):'N/C';
    setCrackStatus(present);

    if(present){
      if(s.crack_mm!=null) byId('crk').textContent=(+s.crack_mm).toFixed(3);
      else if(s.crack_x100!=null) byId('crk').textContent=(s.crack_x100/100).toFixed(3);
      else byId('crk').textContent='-';
    }else byId('crk').textContent='N/C';

    byId('bat').textContent=(s.batt_mV??'-');
    byId('mode').textContent=s.mode||'-';
    byId('ip').textContent=s.ip||'-';
    byId('up').textContent=s.uptime_s??'-';
    byId('heap').textContent=s.heap_free??'-';

    const L=s.lora||{};
    byId('rssi').textContent=(L.rssi!=null)?L.rssi:'—';
    byId('snr').textContent=(L.snr!=null)?L.snr:'—';
    byId('dlage').textContent=(L.age_s!=null)?L.age_s:'—';

    if(s.cfg){
      if(!byId('devEuiField').value)byId('devEuiField').value=s.cfg.devEui||'';
      if(!byId('appEuiField').value)byId('appEuiField').value=s.cfg.appEui||'';
      if(!byId('appKeyField').value)byId('appKeyField').value=s.cfg.appKey||'';
      if(!byId('minutesField').value)byId('minutesField').value=s.cfg.minutes??15;

      const drSel = byId('drField');
      if(drSel){
        if(s.cfg.adr===true) drSel.value='auto';
        else if(s.cfg.dr!=null && s.cfg.dr>=0 && s.cfg.dr<=5) drSel.value=String(s.cfg.dr);
        else drSel.value='auto';
      }

      // Time sync select
      const syncSel = byId('syncField');
      if (syncSel){
        const ts = (s.cfg.time_sync)||{};
        const v = (ts.enabled===false) ? 'off' : String(ts.hours||'off');
        const allowed = ['off','1','2','3','6','12','24','48','72','168'];
        syncSel.value = allowed.includes(v) ? v : 'off';
      }

      if(s.cfg.crack_cal){
        const cc=s.cfg.crack_cal;
        if(cc.r0!=null&&!byId('r0Field').value)byId('r0Field').value=cc.r0;
        if(cc.mm0!=null&&!byId('mm0Field').value)byId('mm0Field').value=(+cc.mm0).toFixed(2);
        if(cc.r1!=null&&!byId('r1Field').value)byId('r1Field').value=cc.r1;
        if(cc.mm1!=null&&!byId('mm1Field').value)byId('mm1Field').value=(+cc.mm1).toFixed(2);
      }
    }
  }catch(e){
    const t=I18N[CURR_LANG]||I18N['en']||{};
    byId('msg').textContent=t.msg_state_error||'state error';
  }
}

/* Actions */
byId('btnReadChip').onclick=readDevEUI;
byId('btnSaveChip').onclick=saveChipDevEUI;
byId('btnSaveLoRa').onclick=saveLoRaAll;
byId('btnSaveCalAll').onclick=saveCrackCalAll;

byId('btnSend').onclick=async()=>{
  const t=I18N[CURR_LANG]||I18N['en']||{};
  try{
    const r=await fetch('/api/send',{method:'POST'});
    byId('msg').textContent=r.ok?(t.msg_send_ok||'LoRa queued'):(t.msg_send_err||'Send error');
  }catch(e){byId('msg').textContent=t.msg_send_err||'Send error'}
};
byId('btnReset').onclick=async()=>{
  const t=I18N[CURR_LANG]||I18N['en']||{};
  try{
    const r=await fetch('/api/reset',{method:'POST'});
    byId('msg').textContent=r.ok?(t.msg_restarting||'restarting…'):(t.msg_reset_forbidden||'Reset forbidden');
  }catch(e){byId('msg').textContent=t.msg_save_error||'Save error'}
};

async function saveLoRaAll(){
  const sel = byId('drField') ? byId('drField').value : 'auto';
  const payload={
    devEui:byId('devEuiField').value.trim(),
    appEui:byId('appEuiField').value.trim(),
    appKey:byId('appKeyField').value.trim(),
    minutes:parseInt(byId('minutesField').value||'15',10)
  };
  if(sel==='auto'){ payload.adr=true; }
  else { payload.dr=parseInt(sel,10); payload.adr=false; }

  // Time sync + align only when sync ON
  const syncVal = byId('syncField') ? byId('syncField').value : 'off';
  if (syncVal === 'off') {
    payload.time_sync = { enabled:false, hours:24 };
    payload.align_minute = false;
  } else {
    const h = parseInt(syncVal,10) || 24;
    payload.time_sync = { enabled:true, hours:h };
    payload.align_minute = true;
  }

  const t=I18N[CURR_LANG]||I18N['en']||{};
  try{
    await fetch('/api/config/lora',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    byId('devEuiMsg').textContent=t.msg_saved_reboot||'Saved; rebooting…';
  }catch(e){byId('devEuiMsg').textContent=t.msg_save_error||'Save error'}
}

async function saveCrackCalAll(){
  const r0=parseInt(byId('r0Field').value,10);
  const r1=parseInt(byId('r1Field').value,10);
  const mm0=parseFloat(byId('mm0Field').value);
  const mm1=parseFloat(byId('mm1Field').value);
  const t=I18N[CURR_LANG]||I18N['en']||{};
  if(!Number.isFinite(r0)||!Number.isFinite(r1)||!Number.isFinite(mm0)||!Number.isFinite(mm1)){
    byId('calMsg').textContent=t.msg_save_error||'Save error';return;
  }
  try{
    await fetch('/api/config/lora',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({crack_cal:{r0,mm0,r1,mm1}})});
    byId('calMsg').textContent=t.msg_saved_reboot||'Saved; rebooting…';
  }catch(e){byId('calMsg').textContent=t.msg_save_error||'Save error'}
}

async function saveChipDevEUI(){
  const t=I18N[CURR_LANG]||I18N['en']||{};
  try{
    await fetch('/api/deveui',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({use:'chip'})});
    byId('devEuiMsg').textContent=t.msg_saved_reboot||'Saved; rebooting…';
  }catch(e){byId('devEuiMsg').textContent=t.msg_save_error||'Save error'}
}
</script>
</body>
</html>
