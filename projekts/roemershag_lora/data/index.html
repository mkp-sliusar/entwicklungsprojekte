<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title id="t_title">LoRa Crack Monitoring</title>
<style>
/* =========================
   Theme and base styling
   ========================= */
:root{
  --bg:#111; --fg:#eee; --card:#1a1a1a; --border:#333; --muted:#9aa; --field:#222; --btn:#222;
  --ff:system-ui,Arial,sans-serif; --fs:14px; --lh:1.35;
  --in-fs:14px; --in-lh:1; --in-pad-y:8px; --in-pad-x:16px; --in-radius:12px;
}
html[data-theme="light"]{
  color-scheme: light;
  /* light palette from lightest to darker */
  --g0:#f6f7f8; --g1:#eef0f1; --g2:#e3e5e7; --g3:#d8dadc; --g4:#cdd0d3; --g5:#c2c5c8;
  --bg:var(--g0);
  --fg:#111; --border:#ddd; --muted:#556; --field:#fff; --btn:#f3f4f6;
  --card:var(--g3);
}
html[data-theme="dark"]{ color-scheme: dark; }

*{box-sizing:border-box}
html,body{height:100%}
html,body{font-family:var(--ff);font-size:var(--fs);line-height:var(--lh)}
body{margin:16px;background:var(--bg);color:var(--fg);display:flex;flex-direction:column;min-height:10svh;max-height:95svh}
.main{flex:1;max-height:85vh;overflow:hidden}
h1{font-size:20px;margin:0 0 12px;display:flex;align-items:center;justify-content:space-between;gap:8px}
h3{margin:0 0 8px}
h1,h3{font-family:var(--ff);line-height:1.2}
h1{font-weight:700} h3{font-weight:600}
.k,small,label{font:inherit}

/* Responsive grid of cards */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column}
.hr{height:1px;background:var(--border);margin:10px 0}

/* Controls */
button,input,select,textarea{font:inherit;line-height:inherit;color:inherit}
input,select,textarea{
  font-size:var(--in-fs);line-height:var(--in-lh);
  padding:var(--in-pad-y) var(--in-pad-x);
  border:1px solid var(--border);border-radius:var(--in-radius);
  background:var(--field);color:var(--fg);
}
input:focus,select:focus,textarea:focus{outline:none;box-shadow:0 0 0 2px inset var(--border)}
select{-webkit-appearance:none;-moz-appearance:none;appearance:none}

/* subtle tone variation across cards */
.grid > .card{ background:var(--cardTone, var(--card)); }
.grid > .card:nth-of-type(5n+1){ --cardTone:var(--g5) }
.grid > .card:nth-of-type(5n+2){ --cardTone:var(--g4) }
.grid > .card:nth-of-type(5n+3){ --cardTone:var(--g3) }
.grid > .card:nth-of-type(5n+4){ --cardTone:var(--g2) }
.grid > .card:nth-of-type(5n+5){ --cardTone:var(--g1) }

/* Field layout */
.field{display:flex;gap:4px;align-items:center;margin-top:8px}
.field input,.field select{flex:1;min-width:0}
.field label{min-width:120px;font-size:16px}

/* Buttons */
.btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--field);color:var(--fg);font-weight:600;margin-top:8px}
.btn:hover{background:var(--btn)}
.btn-block{display:block;width:100%}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.actions{margin-top:auto}

/* LoRa card: two equal-width buttons */
.card:has(#i_lora) .row{display:flex;gap:12px}
.card:has(#i_lora) .row .btn{flex:1 1 0;min-width:0;height:48px;display:flex;align-items:center;justify-content:center}

/* Badges */
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:var(--btn)}
.badge.ok{outline:1px solid #2c7}
.badge.err{outline:1px solid #e55}

small{color:var(--muted)}
#themeBtn,#langBtn{font-size:14px;line-height:1;padding:6px 10px}

/* Footer */
.footer{margin-top:16px;padding-top:12px;border-top:1px solid var(--border);font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
.footer a{color:inherit;text-decoration:none}
.footer a:hover{text-decoration:underline}

/* LoRa layout: label | input grid */
.card:has(#i_lora) .field{display:grid;grid-template-columns:140px 1fr;column-gap:12px;row-gap:12px;align-items:center}
.card:has(#i_lora) .field input,.card:has(#i_lora) .field select{width:100%}

.status{display:block;min-height:1.2em;margin-bottom:6px;color:var(--muted);word-break:break-word;white-space:pre-line}

/* Tablet */
@media (max-width:900px){
  body{margin:10px}
  .main{max-height:none;overflow:auto}
  .grid{grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
  h1{flex-wrap:wrap;gap:8px}
  .row{flex-wrap:wrap;gap:6px}
}

/* Phones */
@media (max-width:640px){
  body{margin:8px}
  h1{flex-direction:column;align-items:flex-start}
  .grid{grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
  .field{flex-direction:column;align-items:stretch}
  .field label{min-width:unset}
  input,.btn,select{width:100%;max-width:100%}
  .row{width:100%}
  .card:has(#i_lora) .field{grid-template-columns:1fr}
}

/* Very narrow phones */
@media (max-width:360px){
  .grid{grid-template-columns:1fr}
  h1 img{height:22px}
  #themeBtn,#langBtn{padding:6px 8px;font-size:13px}
}
</style>
</head>
<body>
<h1>
  <!-- Company link and logo -->
  <a href="https://www.marxkrontal.com/de/" target="_blank" rel="noopener noreferrer" style="display:flex;align-items:center;text-decoration:none;color:inherit;gap:8px">
    <img src="/logo.svg" alt="MKP" style="height:28px;vertical-align:middle">
    <span id="i_title">LoRa Crack Monitoring</span>
  </a>
  <div class="row">
    <button id="langBtn" class="btn" title="Language">EN</button>
    <button id="themeBtn" class="btn" title="Theme">🌙</button>
  </div>
</h1>

<main class="main">
<div class="grid">
  <!-- Sensors card -->
  <div class="card">
    <h3 id="i_sensors">Sensors</h3>
    <div><span class="k" id="i_time_k">Time</span>: <b id="t" aria-live="polite">--:--:--</b></div>
    <div>
      <span class="k" id="i_ds_k">DS18B20</span>: <span id="ds">-</span><span id="ds_unit"> °C</span>
    </div>
    <div><span class="k" id="i_adc_k">Crack ADC</span>: <b id="adc">-</b></div>
    <div><span class="k" id="i_crack_status_k">Crack sensor</span>: <span id="cr_status" class="badge">—</span></div>
    <div><span class="k" id="i_crack_k">Crack</span>: <b id="crk">-</b> <span id="i_mm">mm</span></div>
    <div><span class="k" id="i_bat_k">Battery</span>: <b id="bat">-</b> <span id="i_mv">mV</span></div>
  </div>

  <!-- Controller card -->
  <div class="card">
    <h3 id="i_controller">Controller</h3>
    <div><span class="k" id="i_mode_k">Mode</span>: <b id="mode">-</b></div>
    <div><span class="k" id="i_ip_k">IP</span>: <b id="ip">-</b></div>
    <div><span class="k" id="i_uptime_k">Uptime</span>: <b id="up">-</b> s</div>
    <div><span class="k" id="i_heap_k">Heap</span>: <b id="heap">-</b> B</div>
    <div><span class="k" id="i_rssi_k">RSSI</span>: <b id="rssi">—</b> dBm</div>
    <div><span class="k" id="i_snr_k">SNR</span>: <b id="snr">—</b> dB</div>
    <div><span class="k" id="i_dlage_k">DL age</span>: <b id="dlage">—</b> s</div>
    <div class="hr"></div>
    <div class="actions">
      <small id="msg" class="status" aria-live="polite"></small>
      <div class="row">
        <button id="btnSend" class="btn" type="button">Manual LoRa send</button>
        <button id="btnReset" class="btn" type="button">Reboot</button>
      </div>
    </div>
  </div>

  <!-- LoRa settings card -->
  <div class="card">
    <h3 id="i_lora">LoRa</h3>
    <div class="row">
      <button id="btnReadChip" class="btn" type="button">Read DevEUI from chip</button>
      <button id="btnSaveChip" class="btn" type="button">Use chip DevEUI</button>
    </div>

    <div class="field">
      <label for="devEuiField" id="i_deveui_k">DevEUI</label>
      <input id="devEuiField" inputmode="latin" autocomplete="off" placeholder="DevEUI MSB e.g. 0011223344556677">
    </div>
    <div class="field">
      <label for="appEuiField" id="i_appeui_k">AppEUI</label>
      <input id="appEuiField" inputmode="latin" autocomplete="off" placeholder="AppEUI MSB">
    </div>
    <div class="field">
      <label for="appKeyField" id="i_appkey_k">AppKey</label>
      <input id="appKeyField" inputmode="latin" autocomplete="off" placeholder="AppKey MSB">
    </div>
    <div class="field">
      <label for="minutesField" id="i_interval_k">Interval</label>
      <input id="minutesField" type="number" min="1" placeholder="Interval, min">
    </div>
    <div class="field">
      <label for="drField" id="i_dr_k">DataRate (EU868)</label>
      <select id="drField">
        <option id="opt_dr_auto" value="auto">Auto</option>
        <option value="0">DR0 (SF12 / 125kHz)</option>
        <option value="1">DR1 (SF11 / 125kHz)</option>
        <option value="2">DR2 (SF10 / 125kHz)</option>
        <option value="3">DR3 (SF9  / 125kHz)</option>
        <option value="4">DR4 (SF8  / 125kHz)</option>
        <option value="5">DR5 (SF7  / 125kHz)</option>
      </select>
    </div>

    <!-- Time sync visual control (UI-only; device has stubs) -->
    <div class="field">
      <label for="syncField" id="i_sync_k">Time sync</label>
      <select id="syncField">
        <option value="off">Off</option>
        <option value="1">1 h</option>
        <option value="2">2 h</option>
        <option value="3">3 h</option>
        <option value="6">6 h</option>
        <option value="12">12 h</option>
        <option value="24">24 h</option>
        <option value="48">2 d</option>
        <option value="72">3 d</option>
        <option value="168">1 w</option>
      </select>
    </div>

    <div class="actions">
      <button id="btnSaveLoRa" class="btn btn-block" type="button">Save all LoRa settings</button>
      <small id="devEuiMsg" aria-live="polite"></small>
    </div>
  </div>

  <!-- Crack calibration card -->
  <div class="card">
    <h3 id="i_crcal">Crack calibration</h3>
    <div class="field">
      <label for="r0Field" id="i_r0_k">ADC r0</label>
      <input id="r0Field" type="number" step="1" placeholder="e.g. 25484">
    </div>
    <div class="field">
      <label for="mm0Field" id="i_mm0_k">mm0</label>
      <input id="mm0Field" type="number" step="0.01" min="0" placeholder="e.g. 0">
    </div>
    <div class="field">
      <label for="r1Field" id="i_r1_k">ADC r1</label>
      <input id="r1Field" type="number" step="1" placeholder="e.g. 5">
    </div>
    <div class="field">
      <label for="mm1Field" id="i_mm1_k">mm1</label>
      <input id="mm1Field" type="number" step="0.01" min="0" placeholder="e.g. 10">
    </div>

    <div class="actions">
      <button id="btnSaveCalAll" class="btn btn-block" type="button">Save crack calibration</button>
      <small id="calMsg" aria-live="polite"></small>
    </div>
  </div>
</div>
</main>

<footer class="footer">
  <a href="https://www.marxkrontal.com/de/" target="_blank" rel="noopener noreferrer">© <span id="yr"></span> MKP GmbH</a>
  <span id="i_footer_by">developed by</span>
  <a href="mailto:roman.sliusar@marxkrontal.com">SLR</a>
  <a href="mailto:evgenij.koloda@marxkrontal.com">KOE</a>
  <a href="mailto:Bernd.Schinkoethe@marxkrontal.com">SCE</a>
</footer>

<script>
// =========================
// Constants and helpers
// =========================
const THEME_KEY='theme';
const LANG_KEY='lang';
const LANGS=['en','de','uk'];
let I18N={};
let CURR_LANG='en';

function byId(id){ return document.getElementById(id); }
function setText(id, val){ const el=byId(id); if(el) el.textContent=val; }
function fmtTime(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }

// Safe fetch wrapper: auto-parse JSON when content-type matches
async function q(url,opts){
  const r = await fetch(url,opts);
  if(!r.ok) throw new Error(await r.text());
  const ct = r.headers.get('content-type')||'';
  return ct.includes('application/json') ? r.json() : r.text();
}

// =========================
// Theming
// =========================
function setTheme(t){
  document.documentElement.dataset.theme=t;
  setText('themeBtn', t==='dark' ? '☀️' : '🌙');
  localStorage.setItem(THEME_KEY,t);
}

// =========================
// I18n
// =========================
function applyI18n(){
  const t = I18N[CURR_LANG] || I18N['en'] || {};
  setText('i_title',       t.title || 'LoRa Crack Monitoring');
  setText('t_title',       t.title || 'LoRa Crack Monitoring');
  setText('i_sensors',     t.sensors || 'Sensors');
  setText('i_time_k',      t.time || 'Time');
  setText('i_ds_k',        t.ds18b20 || 'DS18B20');
  setText('i_adc_k',       t.crack_adc || 'Crack ADC');
  setText('i_crack_status_k', t.crack_status || 'Crack sensor');
  setText('i_crack_k',     t.crack || 'Crack');
  setText('i_bat_k',       t.battery || 'Battery');
  setText('i_mm',          t.mm || 'mm');
  setText('i_mv',          t.mv || 'mV');
  setText('i_controller',  t.controller || 'Controller');
  setText('i_mode_k',      t.mode || 'Mode');
  setText('i_ip_k',        t.ip || 'IP');
  setText('i_uptime_k',    t.uptime || 'Uptime');
  setText('i_heap_k',      t.heap || 'Heap');
  setText('i_rssi_k',      t.rssi || 'RSSI');
  setText('i_snr_k',       t.snr || 'SNR');
  setText('i_dlage_k',     t.dl_age || 'DL age');
  setText('i_footer_by',   t.footer_by || 'developed by');
  setText('i_deveui_k',    t.deveui || 'DevEUI');
  setText('i_appeui_k',    t.appeui || 'AppEUI');
  setText('i_appkey_k',    t.appkey || 'AppKey');
  setText('i_interval_k',  t.interval || 'Interval');
  setText('i_crcal',       t.crack_cal || 'Crack calibration');
  setText('i_r0_k',        t.r0 || 'ADC r0');
  setText('i_mm0_k',       t.mm0 || 'mm0');
  setText('i_r1_k',        t.r1 || 'ADC r1');
  setText('i_mm1_k',       t.mm1 || 'mm1');
  setText('i_dr_k',        t.drate || 'DataRate (EU868)');
  setText('i_sync_k',      t.time_sync || 'Time sync');
  const optAuto = byId('opt_dr_auto'); if (optAuto) optAuto.textContent = t.auto || 'Auto';
  setText('langBtn', CURR_LANG.toUpperCase());
}

async function initI18n(){
  try{ I18N = await q('/i18n.json'); }catch(e){ I18N = {}; }
  const saved = localStorage.getItem(LANG_KEY);
  CURR_LANG = saved && LANGS.includes(saved) ? saved : 'en';
  applyI18n();
}

// =========================
// Sensor UI bindings
// =========================
function setCrackStatus(present){
  const t = I18N[CURR_LANG] || I18N['en'] || {};
  const el = byId('cr_status');
  if(!el) return;
  if(present){ el.textContent = t.ok || 'OK'; el.classList.remove('err'); el.classList.add('ok'); }
  else{ el.textContent = t.nc || 'N/C'; el.classList.remove('ok'); el.classList.add('err'); }
}

// =========================
// API data load and form fill
// =========================
async function load(){
  try{
    const s = await q('/api/state');
    setText('t', fmtTime());

    // DS18B20 value; device sends float Celsius or null
    const vRaw = s.DS18B20_Temp;
    const vNum = Number(vRaw);
    const hasVal = vRaw !== null && vRaw !== undefined && Number.isFinite(vNum) && vNum > -100 && vNum < 125;
    if (hasVal) {
      setText('ds', vNum.toFixed(1));
      const dsEl = byId('ds'); dsEl && dsEl.classList.remove('badge','err','ok');
      setText('ds_unit',' °C');
    } else {
      const t = I18N[CURR_LANG] || I18N['en'] || {};
      setText('ds', t.nc || 'N/C');
      const dsEl = byId('ds'); if(dsEl){ dsEl.classList.add('badge','err'); }
      setText('ds_unit','');
    }

    const present = !!s.crack_present;
    setText('adc', present ? (s.adc_raw ?? '-') : 'N/C');
    setCrackStatus(present);

    if(present){
      if(s.crack_mm != null) setText('crk', (+s.crack_mm).toFixed(3));
      else if(s.crack_x100 != null) setText('crk', (s.crack_x100/100).toFixed(3));
      else setText('crk','-');
    } else setText('crk','N/C');

    setText('bat', (s.batt_mV ?? '-'));
    setText('mode', s.mode || '-');
    setText('ip', s.ip || '-');
    setText('up', s.uptime_s ?? '-');
    setText('heap', s.heap_free ?? '-');

    const L = s.lora || {};
    setText('rssi', (L.rssi!=null)?L.rssi:'—');
    setText('snr',  (L.snr!=null)?L.snr:'—');
    setText('dlage',(L.age_s!=null)?L.age_s:'—');

    // Populate config fields only if empty to avoid fighting user edits
    if(s.cfg){
      if(!byId('devEuiField').value) byId('devEuiField').value = s.cfg.devEui || '';
      if(!byId('appEuiField').value) byId('appEuiField').value = s.cfg.appEui || '';
      if(!byId('appKeyField').value) byId('appKeyField').value = s.cfg.appKey || '';
      if(!byId('minutesField').value) byId('minutesField').value = s.cfg.minutes ?? 15;

      const drSel = byId('drField');
      if(drSel){
        if(s.cfg.adr===true) drSel.value='auto';
        else if(s.cfg.dr!=null && s.cfg.dr>=0 && s.cfg.dr<=5) drSel.value=String(s.cfg.dr);
        else drSel.value='auto';
      }

      // Time sync select reflects UI preference only
      const syncSel = byId('syncField');
      if (syncSel){
        const ts = (s.cfg.time_sync)||{};
        const v = (ts.enabled===false) ? 'off' : String(ts.hours||'off');
        const allowed = ['off','1','2','3','6','12','24','48','72','168'];
        syncSel.value = allowed.includes(v) ? v : 'off';
      }

      if(s.cfg.crack_cal){
        const cc=s.cfg.crack_cal;
        if(cc.r0!=null && !byId('r0Field').value)  byId('r0Field').value  = cc.r0;
        if(cc.mm0!=null && !byId('mm0Field').value)byId('mm0Field').value = (+cc.mm0).toFixed(2);
        if(cc.r1!=null && !byId('r1Field').value)  byId('r1Field').value  = cc.r1;
        if(cc.mm1!=null && !byId('mm1Field').value)byId('mm1Field').value = (+cc.mm1).toFixed(2);
      }
    }
  }catch(e){
    const t = I18N[CURR_LANG] || I18N['en'] || {};
    setText('msg', t.msg_state_error || 'state error');
  }
}

// =========================
// Actions
// =========================
async function readDevEUI(){
  try{
    const j = await q('/api/deveui');
    byId('devEuiField').value = j.chip_devEui_msb || '';
    const t = I18N[CURR_LANG] || I18N['en'] || {};
    setText('devEuiMsg', `${(t.chip_msb||'chip MSB')}=${j.chip_devEui_msb}  ${(t.chip_lsb||'LSB')}=${j.chip_devEui_lsb}  ${(t.stored_msb||'stored')}=${j.stored_devEui_msb}`);
  }catch(e){
    const t = I18N[CURR_LANG] || I18N['en'] || {};
    setText('devEuiMsg', t.msg_save_error || 'Save error');
  }
}

async function saveChipDevEUI(){
  const t = I18N[CURR_LANG] || I18N['en'] || {};
  try{
    await fetch('/api/deveui',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({use:'chip'})});
    setText('devEuiMsg', t.msg_saved_reboot || 'Saved; rebooting…');
  }catch(e){ setText('devEuiMsg', t.msg_save_error || 'Save error'); }
}

function normHex(s){ return (s||'').trim().replace(/\s+/g,'').toUpperCase(); }

async function saveLoRaAll(){
  const sel = byId('drField') ? byId('drField').value : 'auto';
  const payload={
    devEui:normHex(byId('devEuiField').value),
    appEui:normHex(byId('appEuiField').value),
    appKey:normHex(byId('appKeyField').value),
    minutes:parseInt(byId('minutesField').value||'15',10)
  };
  if(sel==='auto'){ payload.adr=true; }
  else { payload.dr=parseInt(sel,10); payload.adr=false; }

  // Time sync and align flags: UI preference only
  const syncVal = byId('syncField') ? byId('syncField').value : 'off';
  if (syncVal === 'off') {
    payload.time_sync = { enabled:false, hours:24 };
    payload.align_minute = false;
  } else {
    const h = parseInt(syncVal,10) || 24;
    payload.time_sync = { enabled:true, hours:h };
    payload.align_minute = true;
  }

  const t = I18N[CURR_LANG] || I18N['en'] || {};
  try{
    await fetch('/api/config/lora',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    setText('devEuiMsg', t.msg_saved_reboot || 'Saved; rebooting…');
  }catch(e){ setText('devEuiMsg', t.msg_save_error || 'Save error'); }
}

async function saveCrackCalAll(){
  const r0=parseInt(byId('r0Field').value,10);
  const r1=parseInt(byId('r1Field').value,10);
  const mm0=parseFloat(byId('mm0Field').value);
  const mm1=parseFloat(byId('mm1Field').value);
  const t=I18N[CURR_LANG]||I18N['en']||{};
  if(!Number.isFinite(r0)||!Number.isFinite(r1)||!Number.isFinite(mm0)||!Number.isFinite(mm1)){
    setText('calMsg', t.msg_save_error||'Save error'); return;
  }
  try{
    await fetch('/api/config/lora',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({crack_cal:{r0,mm0,r1,mm1}})});
    setText('calMsg', t.msg_saved_reboot||'Saved; rebooting…');
  }catch(e){ setText('calMsg', t.msg_save_error||'Save error'); }
}

// Manual LoRa send and reboot
byId('btnSend').onclick=async()=>{
  const t=I18N[CURR_LANG]||I18N['en']||{};
  try{
    const r=await fetch('/api/send',{method:'POST'});
    setText('msg', r.ok?(t.msg_send_ok||'LoRa queued'):(t.msg_send_err||'Send error'));
  }catch(e){ setText('msg', t.msg_send_err||'Send error'); }
};
byId('btnReset').onclick=async()=>{
  const t=I18N[CURR_LANG]||I18N['en']||{};
  try{
    const r=await fetch('/api/reset',{method:'POST'});
    setText('msg', r.ok?(t.msg_restarting||'restarting…'):(t.msg_reset_forbidden||'Reset forbidden'));
  }catch(e){ setText('msg', t.msg_save_error||'Save error'); }
};

// =========================
// DevEUI chip helpers
// =========================
byId('btnReadChip').onclick=readDevEUI;
byId('btnSaveChip').onclick=saveChipDevEUI;
byId('btnSaveLoRa').onclick=saveLoRaAll;
byId('btnSaveCalAll').onclick=saveCrackCalAll;

// =========================
// App bootstrap
// =========================
document.addEventListener('DOMContentLoaded',()=>{
  // theme init
  const savedTheme=localStorage.getItem(THEME_KEY);
  const initTheme=savedTheme||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
  setTheme(initTheme);
  byId('themeBtn').onclick=()=>setTheme(document.documentElement.dataset.theme==='dark'?'light':'dark');

  // year in footer
  const y=byId('yr'); if(y) y.textContent=new Date().getFullYear();

  // language switch cycles through whitelist
  byId('langBtn').onclick=()=>{
    const idx=LANGS.indexOf(CURR_LANG); CURR_LANG=LANGS[(idx+1)%LANGS.length];
    localStorage.setItem(LANG_KEY,CURR_LANG); applyI18n();
  };

  // i18n load and first render
  initI18n();

  // periodic state refresh
  setInterval(load,2000); load();
});
</script>
</body>
</html>
